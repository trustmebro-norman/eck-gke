---
{{- if .Values.kibana.enabled }}
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: ${{ .Values.kibana.name }}
spec:
  version: ${{ .Values.kibana.version }}
  count: ${{ .Values.kibana.count }}
  elasticsearchRef:
    name: ${{ .Values.elasticsearch.name }}-cluster
  http:
    service:
      spec:
        type: ${{ .Values.kibana.service_type }}
  podTemplate:
    spec:
      containers:
      - name: kibana
        resources:
          limits:
            memory: ${{ .Values.kibana.kibana_mem_limit }}
            cpu: ${{ .Values.kibana.kibana_cpu_limit }}
          requests:
            memory: ${{ .Values.kibana.kibana_mem_request }}
            cpu: ${{ .Values.kibana.kibana_cpu_request }}
{{- end }}
---
{{- if .Values.kibana.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ${{ .Values.kibana.name }}-ingress
  annotations:
    kubernetes.io/ingress.class: ${{ .Values.kibana.ingress.className }}
    {{- if .Values.kibana.ingress.use_externaldns }}
    external-dns.alpha.kubernetes.io/hostname: kibana.${{ .Values.kibana.ingress.root_domain }} # need to be parameterized
    {{- end }}
spec:
  rules:
  - http:
      paths:
      - path: ${{ .Values.kibana.ingress.path }}
        pathType: ${{ .Values.kibana.ingress.path_type }}
        backend:
          service:
            name: ${{ .Values.kibana.name }}-kb-http
            port:
              number: ${{ .Values.kibana.ingress.port }}
{{- end }}